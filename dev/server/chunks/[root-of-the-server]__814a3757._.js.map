{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/acm/CollabLens_BeTheBuilder26/Frontend/app/api/repo-data/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\n\r\n/* ============================\r\n   TOKEN (OPTIONAL)\r\n============================ */\r\n\r\nconst GITHUB_TOKEN = process.env.GITHUB_TOKEN;\r\n\r\n/*\r\nHelper to build headers.\r\nIf token exists → authenticated requests\r\nIf not → unauthenticated fallback (60/hr)\r\n*/\r\nfunction getHeaders(): HeadersInit {\r\n  const headers: HeadersInit = {\r\n    \"Accept\": \"application/vnd.github.v3+json\",\r\n  };\r\n  if (GITHUB_TOKEN) {\r\n    headers[\"Authorization\"] = `Bearer ${GITHUB_TOKEN}`;\r\n  }\r\n  return headers;\r\n}\r\n\r\n/* ============================\r\n   FETCH COMMITS WITH PAGINATION\r\n============================ */\r\n\r\nasync function fetchAllCommits(owner: string, repo: string) {\r\n  let allCommits: any[] = [];\r\n  let page = 1;\r\n  let hasMore = true;\r\n\r\n  while (hasMore) {\r\n    const response = await fetch(\r\n      `https://api.github.com/repos/${owner}/${repo}/commits?per_page=100&page=${page}`,\r\n      {\r\n        headers: getHeaders(),\r\n      }\r\n    );\r\n\r\n    if (!response.ok) {\r\n      throw new Error(`GitHub API error: ${response.status}`);\r\n    }\r\n\r\n    const data = await response.json();\r\n    \r\n    // Fetch detailed stats for each commit (including additions/deletions)\r\n    const detailedCommits = await Promise.all(\r\n      data.map(async (commit: any) => {\r\n        try {\r\n          const detailResponse = await fetch(\r\n            `https://api.github.com/repos/${owner}/${repo}/commits/${commit.sha}`,\r\n            { headers: getHeaders() }\r\n          );\r\n          \r\n          if (detailResponse.ok) {\r\n            const detail = await detailResponse.json();\r\n            return { ...commit, stats: detail.stats };\r\n          }\r\n        } catch (e) {\r\n          // If detail fetch fails, return commit without stats\r\n          console.warn(`Failed to fetch stats for commit ${commit.sha}`);\r\n        }\r\n        return commit;\r\n      })\r\n    );\r\n    \r\n    allCommits.push(...detailedCommits);\r\n\r\n    // Continue if we got a full page of results\r\n    if (data.length < 100) {\r\n      hasMore = false;\r\n    } else {\r\n      page++;\r\n    }\r\n  }\r\n\r\n  return allCommits;\r\n}\r\n\r\n/* ============================\r\n   DERIVE CONTRIBUTOR DATA FROM COMMITS\r\n============================ */\r\n\r\nfunction deriveContributorStats(commits: any[]) {\r\n  const contributorMap = new Map<string, {\r\n    username: string;\r\n    totalCommits: number;\r\n    additions: number;\r\n    deletions: number;\r\n    firstCommit: Date;\r\n    lastCommit: Date;\r\n    commitDates: Set<string>;\r\n  }>();\r\n\r\n  commits.forEach(commit => {\r\n    const username = commit.author?.login ?? \"Unknown\";\r\n    const date = new Date(commit.commit.author.date);\r\n    const additions = commit.stats?.additions ?? 0;\r\n    const deletions = commit.stats?.deletions ?? 0;\r\n\r\n    if (!contributorMap.has(username)) {\r\n      contributorMap.set(username, {\r\n        username,\r\n        totalCommits: 0,\r\n        additions: 0,\r\n        deletions: 0,\r\n        firstCommit: date,\r\n        lastCommit: date,\r\n        commitDates: new Set()\r\n      });\r\n    }\r\n\r\n    const contributor = contributorMap.get(username)!;\r\n    contributor.totalCommits++;\r\n    contributor.additions += additions;\r\n    contributor.deletions += deletions;\r\n    \r\n    if (date < contributor.firstCommit) contributor.firstCommit = date;\r\n    if (date > contributor.lastCommit) contributor.lastCommit = date;\r\n    \r\n    // Track unique weeks for active weeks calculation\r\n    const weekKey = `${date.getFullYear()}-W${Math.floor(date.getTime() / (7 * 24 * 60 * 60 * 1000))}`;\r\n    contributor.commitDates.add(weekKey);\r\n  });\r\n\r\n  return Array.from(contributorMap.values()).map(contributor => ({\r\n    username: contributor.username,\r\n    totalCommits: contributor.totalCommits,\r\n    activeWeeks: contributor.commitDates.size,\r\n    additions: contributor.additions,\r\n    deletions: contributor.deletions\r\n  }));\r\n}\r\n\r\n/* ============================\r\n   VALIDATE GITHUB URL\r\n============================ */\r\n\r\nfunction extractRepo(repoUrl: string) {\r\n  const match = repoUrl.match(/github\\.com\\/([^\\/]+)\\/([^\\/]+)/);\r\n\r\n  if (!match) return null;\r\n\r\n  return {\r\n    owner: match[1],\r\n    repo: match[2]\r\n  };\r\n}\r\n\r\n/* ============================\r\n   POST ROUTE\r\n============================ */\r\n\r\nexport async function POST(req: Request) {\r\n  try {\r\n    const { repoUrl } = await req.json();\r\n\r\n    if (!repoUrl) {\r\n      return NextResponse.json(\r\n        { error: \"Repo URL required\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const extracted = extractRepo(repoUrl);\r\n\r\n    if (!extracted) {\r\n      return NextResponse.json(\r\n        { error: \"Invalid GitHub repository URL\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const { owner, repo } = extracted;\r\n\r\n    /* ---------- FETCH DATA ---------- */\r\n\r\n    const rawCommits = await fetchAllCommits(owner, repo);\r\n\r\n    /* ---------- CLEAN TIMELINE ---------- */\r\n\r\n    const timeline = rawCommits.map(commit => ({\r\n      username: commit.author?.login ?? \"Unknown\",\r\n      authorName: commit.commit.author.name,\r\n      message: commit.commit.message,\r\n      date: commit.commit.author.date,\r\n      commitUrl: commit.html_url\r\n    }));\r\n\r\n    /* ---------- DERIVE FIGURES FROM COMMITS ---------- */\r\n\r\n    const figures = deriveContributorStats(rawCommits);\r\n\r\n    return NextResponse.json({\r\n      repository: `${owner}/${repo}`,\r\n      timeline,\r\n      figures,\r\n      usingAuthToken: Boolean(GITHUB_TOKEN) // helpful debug flag\r\n    });\r\n\r\n  } catch (error: any) {\r\n\r\n    /* ---------- RATE LIMIT HANDLING ---------- */\r\n\r\n    if (error.message?.includes(\"403\")) {\r\n      return NextResponse.json(\r\n        {\r\n          error: \"GitHub API rate limit exceeded. Try later or add a token.\"\r\n        },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    console.error(error);\r\n\r\n    return NextResponse.json(\r\n      { error: error.message || \"Server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}